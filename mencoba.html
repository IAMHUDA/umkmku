<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Chart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <div class="flex flex-col md:flex-row justify-between items-center mb-3">
      <h1 class="text-2xl font-bold mb-3 md:mb-0">Grafik Pesanan</h1>
      <a href="order.html" class="btn btn-primary">Kembali ke Halaman Utama</a>
      <a href="dashboard.html" class="btn btn-primary">DASBOD</a>
    </div>

    <div class="mb-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
      <input type="text" id="searchCustomerName" class="form-control" placeholder="Cari Nama Pelanggan" />
      <input type="date" id="searchOrderDate" class="form-control" />
      <input type="text" id="searchPaymentMethod" class="form-control" placeholder="Cari Metode Pembayaran" />
      <input type="text" id="searchPaymentStatus" class="form-control" placeholder="Cari Status Pembayaran" />
      <button onclick="searchOrders()" class="btn btn-blue bg-blue-500 text-white">Search</button>
    </div>

    <canvas id="ordersChart" width="100%" height="50vh"></canvas>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // Konfigurasi Firebase
    var firebaseConfig = {
        apiKey: "AIzaSyD6zN162LNFtTV_NnRpok6YctnYmDr5pNlyT2bRjXh0",
        authDomain: "umkmku-6fcce.firebaseapp.com",
        projectId: "umkmku-6fcce",
        storageBucket: "umkmku-6fcce.appspot.com",
        messagingSenderId: "727965779260",
        appId: "1:727965779260:web:5dabdd7694f8b81c30ca39",
        measurementId: "G-QGJ67SZ6WY"
    };
    
    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Inisialisasi Firestore
    var db = firebase.firestore();

    // Function to load and display orders
    function loadOrders(filters = {}) {
        const chartContext = document.getElementById('ordersChart').getContext('2d');
        const labels = [];
        const data = {
            labels: labels,
            datasets: [{
                label: 'Total Pesanan',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };
        
        let query = db.collection('orders');
        
        if (filters.customerName) {
            query = query.where('customerName', '==', filters.customerName);
        }
        if (filters.orderDate) {
            query = query.where('orderDate', '==', filters.orderDate);
        }
        if (filters.paymentMethod) {
            query = query.where('paymentMethod', '==', filters.paymentMethod);
        }
        if (filters.paymentStatus) {
            query = query.where('paymentStatus', '==', filters.paymentStatus);
        }

        query.get().then(querySnapshot => {
            querySnapshot.forEach(doc => {
                const order = doc.data();
                labels.push(order.customerName); // Adjust as needed
                data.datasets[0].data.push(order.totalAmount); // Adjust as needed
            });

            if (window.ordersChart) {
                window.ordersChart.destroy();
            }

            window.ordersChart = new Chart(chartContext, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Total: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }).catch(error => {
            console.error('Error getting orders: ', error);
            Swal.fire('Gagal!', 'Terjadi kesalahan saat memuat pesanan.', 'error');
        });
    }
    
    // Call loadOrders when the page loads
    window.onload = () => loadOrders();
    
    // Function to search and filter orders
    function searchOrders() {
        const customerName = document.getElementById('searchCustomerName').value;
        const orderDate = document.getElementById('searchOrderDate').value;
        const paymentMethod = document.getElementById('searchPaymentMethod').value;
        const paymentStatus = document.getElementById('searchPaymentStatus').value;

        const filters = {
            customerName: customerName || undefined,
            orderDate: orderDate || undefined,
            paymentMethod: paymentMethod || undefined,
            paymentStatus: paymentStatus || undefined
        };
        
        loadOrders(filters);
    }
  </script>
</body>
</html>
